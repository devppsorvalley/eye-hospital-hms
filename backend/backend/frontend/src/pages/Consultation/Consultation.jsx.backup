import { useState, useEffect } from 'react';
import { authStore } from '../../store/auth.store';
import Layout from '../../components/layout/Layout';
import { 
  getICDCodes, 
  getTodayOPDQueue, 
  getPatientConsultations, 
  createConsultation,
  updateConsultation,
  addICDCode,
  removeICDCode
} from '../../api/consultation.api';
import '../../styles/consultation.css';

function Consultation() {
  const [user] = useState(() => authStore.getUser());
  
  // Debug: Log user data
  useEffect(() => {
    console.log('Consultation - User data:', user);
    console.log('Consultation - User role:', user?.role);
  }, [user]);
  
  // State
  const [queue, setQueue] = useState([]);
  const [icdMaster, setICDMaster] = useState([]);
  const [selectedICDs, setSelectedICDs] = useState([]);
  const [patientHistory, setPatientHistory] = useState([]);
  const [consultationId, setConsultationId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [showAISummary, setShowAISummary] = useState(false);
  const [aiFeedbackSubmitted, setAiFeedbackSubmitted] = useState(false);

  // Form data
  const [patientData, setPatientData] = useState({
    uhid: '',
    serial_no: '',
    name: '',
    gender: '',
    age: '',
    phone: '',
    opd_id: null
  });

  const [clinicalNotes, setClinicalNotes] = useState({
    diagnosis: '',
    treatment_plan: '',
    followup_instructions: ''
  });

  // Load initial data
  useEffect(() => {
    if (user?.role === 'DOCTOR') {
      // Map user IDs to doctor IDs (temporary mapping)
      // user_id 2 (dr.aditya) -> doctor_id 1 (Dr Aditya)
      // user_id 6 (doctor) -> doctor_id 1 (Dr Aditya) 
      let doctorId = 1; // Default to Dr Aditya
      
      if (user.id === 2) {
        doctorId = 1; // dr.aditya -> Dr Aditya
      } else if (user.id === 6) {
        doctorId = 1; // doctor -> Dr Aditya (for demo)
      }
      
      fetchTodayQueue(doctorId);
      fetchICDCodes();
    }
  }, [user]);

  const fetchTodayQueue = async (doctorId) => {
    try {
      console.log('[Consultation] Fetching queue for doctor_id:', doctorId);
      const response = await getTodayOPDQueue(doctorId);
      console.log('[Consultation] Queue API response:', response);
      const queueData = response.data || [];
      console.log('[Consultation] Queue data array:', queueData);
      setQueue(queueData);
    } catch (error) {
      console.error('Failed to load OPD queue:', error);
      console.error('Error details:', error.response?.data);
    }
  };

  const fetchICDCodes = async () => {
    try {
      const response = await getICDCodes();
      setICDMaster(response.icd_codes || []);
    } catch (error) {
      console.error('Failed to load ICD codes:', error);
    }
  };

  const fetchPatientHistory = async (uhid) => {
    try {
      const response = await getPatientConsultations(uhid);
      setPatientHistory(response.data || []);
    } catch (error) {
      console.error('Failed to load patient history:', error);
      setPatientHistory([]);
    }
  };

  const loadPatientFromQueue = (queueEntry) => {
    console.log('Loading patient from queue:', queueEntry);
    setPatientData({
      uhid: queueEntry.uhid,
      serial_no: queueEntry.serial_no,
      name: `${queueEntry.first_name || ''} ${queueEntry.last_name || ''}`.trim(),
      gender: queueEntry.gender || '',
      age: queueEntry.age ? String(queueEntry.age) : '',
      phone: queueEntry.phone || '',
      opd_id: queueEntry.id
    });

    // Clear clinical notes for new patient
    setClinicalNotes({
      diagnosis: '',
      treatment_plan: '',
      followup_instructions: ''
    });
    setSelectedICDs([]);
    setConsultationId(null);

    // Fetch patient history
    fetchPatientHistory(queueEntry.uhid);

    // Update queue status to IN_PROGRESS
    updateQueueStatus(queueEntry.id, 'IN_PROGRESS');
  };

  const updateQueueStatus = (queueId, status) => {
    setQueue(prevQueue =>
      prevQueue.map(entry =>
        entry.id === queueId ? { ...entry, status } : entry
      )
    );
  };

  const handleICDSelect = (e) => {
    const options = Array.from(e.target.selectedOptions);
    const selected = options.map(opt => {
      const icd = icdMaster.find(i => i.id === parseInt(opt.value));
      return { id: icd.id, icd_code: icd.icd_code, description: icd.description };
    });
    setSelectedICDs(selected);
  };

  const handleUpdate = async () => {
    if (!patientData.uhid) {
      alert('Please load a patient first');
      return;
    }

    if (!clinicalNotes.diagnosis.trim()) {
      alert('Please enter diagnosis');
      return;
    }

    setLoading(true);
    try {
      let consultation;

      // Map user IDs to doctor IDs
      let doctorId = 1; // Default to Dr Aditya
      if (user.id === 2) {
        doctorId = 1; // dr.aditya -> Dr Aditya
      } else if (user.id === 6) {
        doctorId = 1; // doctor -> Dr Aditya
      }

      if (!consultationId) {
        // Create new consultation
        const consultData = {
          uhid: patientData.uhid,
          doctor_id: doctorId,
          opd_id: patientData.opd_id,
          diagnosis: clinicalNotes.diagnosis,
          treatment_plan: clinicalNotes.treatment_plan,
          followup_instructions: clinicalNotes.followup_instructions
        };

        const response = await createConsultation(consultData);
        consultation = response.consultation;
        setConsultationId(consultation.id);

        // Add ICD codes
        for (const icd of selectedICDs) {
          await addICDCode(consultation.id, icd.id);
        }
      } else {
        // Update existing consultation
        const response = await updateConsultation(consultationId, clinicalNotes);
        consultation = response.consultation;
      }

      // Update queue status to COMPLETED
      updateQueueStatus(patientData.opd_id, 'COMPLETED');

      alert('Consultation saved successfully');
      clearForm();
    } catch (error) {
      console.error('Failed to save consultation:', error);
      alert('Failed to save consultation: ' + (error.response?.data?.message || error.message));
    } finally {
      setLoading(false);
    }
  };

  const clearForm = () => {
    setPatientData({
      uhid: '',
      serial_no: '',
      name: '',
      gender: '',
      age: '',
      phone: '',
      opd_id: null
    });
    setClinicalNotes({
      diagnosis: '',
      treatment_plan: '',
      followup_instructions: ''
    });
    setSelectedICDs([]);
    setPatientHistory([]);
    setConsultationId(null);
    setShowAISummary(false);
    setAiFeedbackSubmitted(false);
  };

  const submitAIFeedback = async (feedbackType) => {
    try {
      const token = localStorage.getItem('token');
      
      // Generate the current AI protocol to save
      const aiProtocolText = generateAISummary();
      
      const response = await fetch('http://localhost:3000/api/v1/consultations/ai-feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          consultation_id: consultationId,
          diagnosis: clinicalNotes.diagnosis,
          icd_codes: selectedICDs.map(icd => icd.icd_code),
          ai_protocol_text: aiProtocolText, // Save the complete AI recommendation
          patient_age: parseInt(patientData.age) || null,
          patient_gender: patientData.gender || null,
          feedback_type: feedbackType
        })
      });

      if (response.ok) {
        setAiFeedbackSubmitted(true);
        console.log('AI feedback submitted:', feedbackType);
        console.log('Protocol saved for training:', aiProtocolText.substring(0, 100) + '...');
      }
    } catch (error) {
      console.error('Failed to submit AI feedback:', error);
    }
  };

  const getStatusClass = (status) => {
    switch (status) {
      case 'WAITING': return 'status-waiting';
      case 'IN_PROGRESS': return 'status-progress';
      case 'COMPLETED': return 'status-done';
      default: return '';
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('en-IN', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const generateAISummary = () => {
    if (!patientData.uhid) {
      return 'Load a patient to see AI-generated recommendations.';
    }

    const hasHistory = patientHistory.length > 0;
    const currentDiagnosis = clinicalNotes.diagnosis.trim();
    const age = parseInt(patientData.age) || 0;
    const primaryICD = selectedICDs[0];

    if (!primaryICD && !currentDiagnosis) {
      return 'Enter diagnosis and select ICD codes to generate AI recommendations.';
    }

    let protocol = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
    protocol += `   AI-RECOMMENDED TREATMENT PROTOCOL\n`;
    protocol += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    protocol += `Patient: ${patientData.name} | Age: ${age} yrs | Gender: ${patientData.gender}\n`;
    
    if (primaryICD) {
      protocol += `Primary ICD: ${primaryICD.icd_code} â€” ${primaryICD.description}\n`;
    }
    protocol += `\nâš ï¸  This recommendation is generated based on patient age, symptoms, and clinical guidelines.\n`;
    protocol += `    Final decision rests with the treating ophthalmologist.\n\n`;
    protocol += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;

    // Generate condition-specific protocol
    const icdCode = primaryICD?.icd_code || '';
    
    if (icdCode.startsWith('H25') || icdCode.startsWith('H26')) {
      // Cataract protocols
      protocol += generateCataractProtocol(age, icdCode, primaryICD?.description);
    } else if (icdCode.startsWith('H40')) {
      // Glaucoma protocols
      protocol += generateGlaucomaProtocol(age, icdCode, primaryICD?.description);
    } else if (icdCode.startsWith('H52')) {
      // Refractive error protocols
      protocol += generateRefractiveProtocol(age, icdCode, primaryICD?.description);
    } else if (icdCode.startsWith('H53')) {
      // Visual disturbance protocols
      protocol += generateVisualDisturbanceProtocol(age, icdCode);
    } else {
      // Generic protocol
      protocol += generateGenericProtocol(age, currentDiagnosis);
    }

    // Add patient history context
    if (hasHistory) {
      protocol += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
      protocol += `ğŸ“‹ PATIENT HISTORY CONTEXT\n\n`;
      protocol += `Previous consultations: ${patientHistory.length}\n`;
      const lastVisit = patientHistory[0];
      if (lastVisit) {
        protocol += `Last visit: ${formatDate(lastVisit.created_at)}\n`;
        protocol += `Previous diagnosis: ${lastVisit.diagnosis?.substring(0, 80) || 'Not recorded'}\n`;
        protocol += `\nâš•ï¸  AI Note: Review treatment continuity and response to previous therapy.\n`;
      }
    }

    protocol += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    protocol += `ğŸ¤– AI Confidence Level: ${selectedICDs.length > 0 ? 'HIGH' : 'MEDIUM'} (based on data completeness)\n`;
    protocol += `Generated: ${new Date().toLocaleString('en-IN')}\n`;

    return protocol;
  };

  const generateCataractProtocol = (age, icdCode, description) => {
    return `1ï¸âƒ£  CLINICAL ASSESSMENT (AI Checks First)
   â€¢ Gradual, painless reduction in distance vision
   â€¢ Difficulty with night driving / glare sensitivity
   â€¢ Nuclear/cortical sclerosis on slit-lamp exam
   â€¢ No acute pain, redness, or inflammation
   â€¢ Retina view assessable for fundus examination

AI Confidence Level: High (typical age-related cataract presentation)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2ï¸âƒ£  PRIMARY RECOMMENDATION

Definitive Treatment: CATARACT SURGERY

Suggested Procedure:
   â€¢ Phacoemulsification with Posterior Chamber IOL implantation

Rationale (AI Logic):
   â€¢ ${age > 50 ? 'Age-related' : 'Early-onset'} cataract does not regress with medication
   â€¢ Surgery offers predictable and permanent visual improvement
   â€¢ Delaying surgery may increase lens hardness and surgical difficulty

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3ï¸âƒ£  PRE-SURGICAL OPTIMIZATION (Before Surgery)

AI suggests ordering:
   âœ“ Biometry (IOL power calculation - SRK/T or Barrett formula)
   âœ“ Keratometry / Corneal topography
   âœ“ Dilated fundus examination
   âœ“ Basic systemic fitness assessment:
      - Blood Pressure check
      - Random Blood Sugar (if diabetic history)
      - ECG (if age >60 or cardiac history)

If Comorbidities Present:
   âš ï¸  Optimize diabetes/hypertension before surgery
   âš ï¸  Control intraocular inflammation if present

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4ï¸âƒ£  INTERIM / SUPPORTIVE MANAGEMENT (If Surgery Deferred)

If patient chooses to wait or surgery temporarily deferred:
   â€¢ Update distance spectacles (temporary measure)
   â€¢ Counsel on:
      - Use adequate lighting for reading
      - Avoid night driving if glare severe
      - Consider UV-protective sunglasses outdoors
   â€¢ Lubricating eye drops if associated dryness

âš ï¸  AI Note: No eye drops can reverse cataract formation.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

5ï¸âƒ£  POST-SURGICAL CARE (Standard Protocol)

AI-recommended post-op regimen:
   Week 1-2:
      â€¢ Topical antibiotic + steroid combination (4x/day)
      â€¢ NSAID eye drops (2x/day) for CME prevention
      â€¢ Eye shield at night for 1 week
      â€¢ Avoid eye rubbing, heavy lifting, water splash

   Week 3-4:
      â€¢ Taper steroids gradually (3x, 2x, 1x, stop)
      â€¢ Continue NSAID if needed

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

6ï¸âƒ£  FOLLOW-UP SCHEDULE (AI Suggested)

   Day 1:    Wound check, IOP measurement, corneal clarity
   Week 1:   Vision improvement assessment, inflammation check
   Week 4-6: Final refraction and spectacle prescription

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

7ï¸âƒ£  RED-FLAG ALERTS (AI Auto-Warnings)

Advise IMMEDIATE review if patient reports:
   ğŸš¨ Sudden drop in vision post-surgery
   ğŸš¨ Increasing pain or redness
   ğŸš¨ Excessive watering or purulent discharge
   ğŸš¨ New onset flashes or floaters (rule out retinal issues)
   ğŸš¨ Persistent IOP elevation

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

8ï¸âƒ£  AI SUMMARY FOR DOCTOR DASHBOARD

Findings consistent with ${description}. Cataract surgery (Phaco + IOL) 
recommended. Expected visual prognosis: GOOD with timely intervention.
Estimated recovery time: 4-6 weeks for complete visual rehabilitation.`;
  };

  const generateGlaucomaProtocol = (age, icdCode, description) => {
    return `1ï¸âƒ£  CLINICAL ASSESSMENT

   â€¢ Elevated intraocular pressure (IOP >21 mmHg)
   â€¢ Optic disc cupping (C/D ratio assessment)
   â€¢ Visual field defects on perimetry
   â€¢ Angle assessment via gonioscopy

AI Confidence: High (glaucoma suspect/confirmed)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2ï¸âƒ£  PRIMARY TREATMENT STRATEGY

Medical Management (First-line):
   â€¢ Topical prostaglandin analogs (Latanoprost/Travoprost)
      - Target: Reduce IOP by 20-30%
      - Timing: Once daily at bedtime

Alternative/Additional:
   â€¢ Beta-blockers (Timolol 0.5%) if PG insufficient
   â€¢ Carbonic anhydrase inhibitors (Dorzolamide)
   â€¢ Alpha-agonists (Brimonidine)

âš ï¸  AI Note: Target IOP varies; aim for individualized pressure.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3ï¸âƒ£  MONITORING PROTOCOL

Baseline Studies Required:
   âœ“ IOP measurement (multiple readings)
   âœ“ Optic disc photography/OCT
   âœ“ Visual field testing (Humphrey 24-2 or 30-2)
   âœ“ Pachymetry (central corneal thickness)

Follow-up Frequency:
   â€¢ Initial: Every 2-4 weeks until IOP controlled
   â€¢ Maintenance: Every 3-6 months with VF/OCT annually

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4ï¸âƒ£  SURGICAL OPTIONS (If Medical Failure)

Consider if:
   â€¢ IOP not controlled on maximum tolerated medications
   â€¢ Progressive visual field loss despite treatment
   â€¢ Non-compliance or medication intolerance

Procedures (AI ranked by invasiveness):
   1. Selective Laser Trabeculoplasty (SLT)
   2. Trabeculectomy with MMC
   3. Glaucoma drainage devices (Ahmed/Baerveldt)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

5ï¸âƒ£  PATIENT COUNSELING (AI Emphasized)

Critical Points:
   â€¢ Glaucoma is chronic; requires lifelong management
   â€¢ Vision loss is irreversible but progression preventable
   â€¢ Medication compliance is ESSENTIAL
   â€¢ Regular follow-up mandatory

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

6ï¸âƒ£  RED-FLAG SYMPTOMS

Urgent review needed if:
   ğŸš¨ Sudden severe eye pain (acute angle closure?)
   ğŸš¨ Rapid vision deterioration
   ğŸš¨ Persistent headaches with blurred vision
   ğŸš¨ IOP >30 mmHg despite treatment`;
  };

  const generateRefractiveProtocol = (age, icdCode, description) => {
    return `1ï¸âƒ£  REFRACTIVE ERROR ASSESSMENT

Condition: ${description}
Age Group: ${age < 18 ? 'Pediatric' : age < 40 ? 'Young Adult' : 'Presbyopic Range'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2ï¸âƒ£  RECOMMENDED CORRECTION

Primary Options:
   ${age < 18 ? 
     'â€¢ Spectacles (preferred for children)\n   â€¢ Monitor progression every 6-12 months' :
     age < 40 ?
     'â€¢ Spectacles or Contact Lenses\n   â€¢ LASIK/PRK if stable refraction for 1 year\n   â€¢ Patient must be >18 years, refractive stability confirmed' :
     'â€¢ Spectacles (single vision or progressive)\n   â€¢ Consider multifocal contact lenses\n   â€¢ Refractive surgery options limited in presbyopia'
   }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3ï¸âƒ£  MANAGEMENT PROTOCOL

Spectacle Prescription:
   â€¢ Full cycloplegic refraction ${age < 16 ? '(mandatory for children)' : '(if needed)'}
   â€¢ Update prescription annually or if symptoms worsen

Contact Lens Protocol (if applicable):
   â€¢ Daily disposable preferred for hygiene
   â€¢ Regular follow-up every 6 months
   â€¢ Strict hygiene counseling

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4ï¸âƒ£  REFRACTIVE SURGERY CANDIDACY (If Applicable)

Eligibility Criteria:
   âœ“ Age >18 years (preferably >21)
   âœ“ Stable refraction for 12+ months
   âœ“ Adequate corneal thickness (>500 microns)
   âœ“ No active eye disease
   âœ“ Realistic expectations

Pre-op Workup:
   â€¢ Corneal topography/tomography
   â€¢ Wavefront aberrometry
   â€¢ Tear film assessment

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

5ï¸âƒ£  FOLLOW-UP RECOMMENDATIONS

   â€¢ Annual eye examination
   â€¢ Monitor for progression (especially if high myopia)
   â€¢ Screen for retinal complications if myopia >-6.00D`;
  };

  const generateVisualDisturbanceProtocol = (age, icdCode) => {
    return `1ï¸âƒ£  DIFFERENTIAL DIAGNOSIS CONSIDERATIONS

Visual disturbances require systematic evaluation:
   â€¢ Refractive error correction status
   â€¢ Media opacities (cataract, corneal issues)
   â€¢ Retinal pathology (if not already examined)
   â€¢ Neurological causes (if bilateral/unexplained)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2ï¸âƒ£  RECOMMENDED WORKUP

Essential Tests:
   âœ“ Best corrected visual acuity
   âœ“ Refraction (cycloplegic if indicated)
   âœ“ Slit-lamp examination
   âœ“ Dilated fundus examination
   âœ“ Amsler grid testing

Advanced (if indicated):
   â€¢ OCT macula
   â€¢ Visual field testing
   â€¢ Neuroimaging (if optic nerve involvement suspected)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3ï¸âƒ£  TREATMENT APPROACH

Based on Underlying Cause:
   â€¢ If refractive: Correct with appropriate spectacles
   â€¢ If cataract: Consider surgical referral
   â€¢ If macular: Medical/laser treatment as indicated
   â€¢ If functional: Reassurance + follow-up

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4ï¸âƒ£  FOLLOW-UP PROTOCOL

   â€¢ Short-term: 2-4 weeks (if acute/worsening)
   â€¢ Routine: 3-6 months if stable
   â€¢ Urgent referral if sudden onset/progressive`;
  };

  const generateGenericProtocol = (age, diagnosis) => {
    // Enhanced generic protocol that uses diagnosis text
    const diagnosisLower = diagnosis.toLowerCase();
    let protocol = `1ï¸âƒ£  CLINICAL EVALUATION

`;
    protocol += `Current Diagnosis: ${diagnosis || 'Under evaluation'}\n`;
    protocol += `Patient Age: ${age} years\n\n`;

    // Analyze diagnosis text for keywords
    const keywords = {
      cataract: diagnosisLower.includes('cataract'),
      glaucoma: diagnosisLower.includes('glaucoma'),
      retina: diagnosisLower.includes('retina') || diagnosisLower.includes('retinal'),
      cornea: diagnosisLower.includes('cornea') || diagnosisLower.includes('corneal'),
      conjunctivitis: diagnosisLower.includes('conjunctivitis') || diagnosisLower.includes('red eye'),
      dryeye: diagnosisLower.includes('dry') || diagnosisLower.includes('tear'),
      refractive: diagnosisLower.includes('myopia') || diagnosisLower.includes('hyperopia') || diagnosisLower.includes('astigmatism')
    };

    protocol += `AI Analysis of Diagnosis Text:\n`;
    if (keywords.cataract) {
      protocol += `   âš•ï¸  Cataract-related condition detected. Consider phacoemulsification.\n`;
    }
    if (keywords.glaucoma) {
      protocol += `   âš•ï¸  Glaucoma-related condition. Monitor IOP and consider medical therapy.\n`;
    }
    if (keywords.retina) {
      protocol += `   âš•ï¸  Retinal condition. May require dilated fundus exam and OCT.\n`;
    }
    if (keywords.cornea) {
      protocol += `   âš•ï¸  Corneal condition. Consider slit-lamp examination and topical therapy.\n`;
    }
    if (keywords.conjunctivitis) {
      protocol += `   âš•ï¸  Conjunctivitis suspected. Consider antibiotic/antiviral drops.\n`;
    }
    if (keywords.dryeye) {
      protocol += `   âš•ï¸  Dry eye symptoms. Consider lubricating drops and punctal plugs.\n`;
    }
    if (keywords.refractive) {
      protocol += `   âš•ï¸  Refractive error. Consider spectacle/contact lens correction.\n`;
    }

    protocol += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
    protocol += `2ï¸âƒ£  GENERAL RECOMMENDATIONS\n\n`;
    protocol += `Based on standard ophthalmic protocols:\n`;
    protocol += `   â€¢ Complete comprehensive eye examination\n`;
    protocol += `   â€¢ Address chief complaints systematically\n`;
    protocol += `   â€¢ Rule out urgent/emergent conditions\n`;
    protocol += `   â€¢ Appropriate referral if specialized care needed\n\n`;

    protocol += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
    protocol += `3ï¸âƒ£  TREATMENT APPROACH\n\n`;
    protocol += `Will depend on specific diagnosis confirmed:\n`;
    protocol += `   â€¢ Medical management (if applicable)\n`;
    protocol += `   â€¢ Surgical intervention (if indicated)\n`;
    protocol += `   â€¢ Supportive care and patient education\n\n`;

    protocol += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
    protocol += `4ï¸âƒ£  FOLLOW-UP\n\n`;
    protocol += `   â€¢ As per clinical judgment\n`;
    protocol += `   â€¢ Typically 2-4 weeks for review\n`;
    protocol += `   â€¢ Earlier if symptoms worsen\n\n`;

    protocol += `âš•ï¸  Note: More specific AI recommendations available when ICD codes are selected.\n`;
    protocol += `       Add ICD-10 codes for detailed treatment protocols.`;

    return protocol;
  };

  if (user?.role !== 'DOCTOR') {
    return (
      <Layout>
        <div className="consultation-container">
          <div className="error-message">
            Access Denied. Only doctors can access consultation.
          </div>
        </div>
      </Layout>
    );
  };

  // Get doctor name (capitalize username and add Dr prefix if no name)
  const getDoctorName = () => {
    if (user.name) return user.name;
    const username = user.username || '';
    if (username.startsWith('dr.')) {
      return 'Dr. ' + username.slice(3).split('.').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }
    return username.charAt(0).toUpperCase() + username.slice(1);
  };

  return (
    <Layout>
      <div className="consultation-container">
        <h2 className="page-title">Patient Consultation</h2>
        <div className="consultation-layout">
          {/* LEFT PANEL */}
          <div className="consultation-left-panel">
            <h3>Patient Consultation</h3>
            
            <div className="doctor-info">
              <strong>Logged-in Doctor:</strong> {getDoctorName()}
            </div>

          <hr />

          <h4>Patient Details</h4>
          <div className="patient-details-grid">
            <div className="form-field">
              <label>UHID</label>
              <input type="text" value={patientData.uhid} disabled />
            </div>
            <div className="form-field">
              <label>OPD Serial No.</label>
              <input type="text" value={patientData.serial_no} disabled />
            </div>
            <div className="form-field">
              <label>Gender</label>
              <input type="text" value={patientData.gender} disabled />
            </div>
            <div className="form-field">
              <label>Full Name</label>
              <input type="text" value={patientData.name} disabled />
            </div>
            <div className="form-field">
              <label>Age</label>
              <input type="text" value={patientData.age} disabled />
            </div>
            <div className="form-field">
              <label>Phone</label>
              <input type="text" value={patientData.phone} disabled />
            </div>
          </div>

          <hr />

          <h4>Doctor's Clinical Notes</h4>

          <div className="form-field">
            <label>ICD Codes</label>
            <select 
              multiple 
              className="icd-select"
              onChange={handleICDSelect}
              value={selectedICDs.map(icd => icd.id.toString())}
              disabled={!patientData.uhid}
            >
              {icdMaster.map(icd => (
                <option key={icd.id} value={icd.id}>
                  {icd.icd_code} â€” {icd.description}
                </option>
              ))}
            </select>
            <div className="icd-hint">Hold Ctrl (Cmd on Mac) to select multiple codes</div>
            <div className="selected-icd-tags">
              {selectedICDs.length === 0 ? (
                <em>No ICD codes selected</em>
              ) : (
                selectedICDs.map(icd => (
                  <span key={icd.id} className="icd-tag">
                    {icd.icd_code} â€” {icd.description}
                  </span>
                ))
              )}
            </div>
          </div>

          <div className="form-field">
            <label>Diagnosis</label>
            <textarea 
              rows="3"
              value={clinicalNotes.diagnosis}
              onChange={(e) => setClinicalNotes({ ...clinicalNotes, diagnosis: e.target.value })}
              placeholder="Enter diagnosis..."
              disabled={!patientData.uhid}
            />
          </div>

          <div className="form-field">
            <label>Treatment Plan</label>
            <textarea 
              rows="3"
              value={clinicalNotes.treatment_plan}
              onChange={(e) => setClinicalNotes({ ...clinicalNotes, treatment_plan: e.target.value })}
              placeholder="Enter treatment plan..."
              disabled={!patientData.uhid}
            />
          </div>

          <div className="form-field">
            <label>Follow-up Instructions</label>
            <textarea 
              rows="3"
              value={clinicalNotes.followup_instructions}
              onChange={(e) => setClinicalNotes({ ...clinicalNotes, followup_instructions: e.target.value })}
              placeholder="Enter follow-up instructions..."
              disabled={!patientData.uhid}
            />
          </div>

          <hr />

          <div className="ai-toggle">
            <label>
              <input 
                type="checkbox" 
                checked={showAISummary}
                onChange={(e) => setShowAISummary(e.target.checked)}
              />
              {' '}Show AI Summary & Recommendation
            </label>
          </div>

          {showAISummary && (
            <div className="ai-summary-box">
              <h5>AI-Generated Treatment Protocol</h5>
              <textarea 
                rows="25" 
                disabled 
                value={generateAISummary()}
                style={{ 
                  background: '#f8f9fa', 
                  color: '#2c3e50',
                  fontFamily: 'monospace',
                  fontSize: '12px',
                  lineHeight: '1.6',
                  whiteSpace: 'pre-wrap'
                }}
              />
              <div className="ai-feedback">
                {aiFeedbackSubmitted ? (
                  <span style={{ color: '#28a745', fontWeight: 'bold' }}>
                    âœ“ Thank you for your feedback!
                  </span>
                ) : (
                  <>
                    <small style={{ color: '#6b6f73', marginRight: '10px' }}>Was this protocol helpful?</small>
                    <button 
                      className="btn-small" 
                      onClick={() => submitAIFeedback('helpful')}
                      disabled={!patientData.uhid}
                    >
                      ğŸ‘ Yes
                    </button>
                    {' '}
                    <button 
                      className="btn-small" 
                      onClick={() => submitAIFeedback('not_helpful')}
                      disabled={!patientData.uhid}
                    >
                      ğŸ‘ No
                    </button>
                  </>
                )}
              </div>
            </div>
          )}

          <div className="form-actions">
            <button 
              className="btn-primary" 
              onClick={handleUpdate}
              disabled={loading || !patientData.uhid}
            >
              {loading ? 'Saving...' : 'Update'}
            </button>
            <button className="btn-secondary" onClick={clearForm}>
              Clear
            </button>
          </div>
        </div>

        {/* RIGHT PANEL */}
        <div className="consultation-right-panel">
          <h4>Today's OPD Queue</h4>
          <div className="queue-list">
            {queue.length === 0 ? (
              <p className="no-data">No patients in queue</p>
            ) : (
              queue.map(entry => (
                <div key={entry.id} className="queue-item">
                  <div className="queue-info">
                    <div className="queue-header">
                      <strong>{String(entry.serial_no).padStart(2, '0')}</strong> â€” {entry.first_name} {entry.last_name}
                    </div>
                    <div className="queue-meta">
                      {entry.uhid} â€¢ {entry.phone}
                    </div>
                  </div>
                  <div className="queue-actions">
                    <span className={`status-badge ${getStatusClass(entry.status)}`}>
                      {entry.status.replace('_', ' ')}
                    </span>
                    <button 
                      className="btn-small"
                      onClick={() => loadPatientFromQueue(entry)}
                      disabled={entry.status === 'COMPLETED'}
                    >
                      Load
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>

          {patientData.uhid && (
            <>
              <hr />
              <h4>Patient History</h4>
              <div className="history-list">
                {patientHistory.length === 0 ? (
                  <p className="no-data">No previous consultations</p>
                ) : (
                  patientHistory.map(history => (
                    <div key={history.id} className="history-item">
                      <div className="history-date">{formatDate(history.created_at)}</div>
                      <div className="history-doctor">{history.doctor_name}</div>
                      <div className="history-diagnosis">
                        {history.diagnosis || 'No diagnosis recorded'}
                      </div>
                      <span className={`status-badge ${getStatusClass('COMPLETED')}`}>
                        COMPLETED
                      </span>
                    </div>
                  ))
                )}
              </div>
            </>
          )}
        </div>
      </div>
      </div>
    </Layout>
  );
}

export default Consultation;

